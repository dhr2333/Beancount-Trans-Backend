# 系统需求文档

本文档记录系统的核心需求和设计原则，供开发时参考，确保新功能不会覆盖现有需求。

## 核心需求

### 1. 手机号核心认证系统（新增需求）

#### 1.1 核心原则
- **手机号验证作为核心认证方式**：所有用户必须绑定手机号才能使用系统
- **多账号绑定同一用户**：支持OAuth、用户名、邮箱、手机号等多种登录方式绑定到同一用户
- **OAuth强制绑定流程**：禁用OAuth自动注册，新用户必须先通过手机号注册
- **手机号严格唯一**：一个手机号只能绑定一个用户账户
- **可选2FA**：用户可以选择启用TOTP或SMS双因素认证

#### 1.2 登录方式
- 手机号 + 验证码登录
- 手机号 + 密码登录
- 用户名 + 密码登录（要求已绑定手机号）
- 邮箱 + 密码登录（要求已绑定手机号）
- OAuth登录（GitHub、Google，要求已绑定手机号）

#### 1.3 用户流程
- **新用户注册**：必须通过手机号注册接口，自动绑定手机号
- **现有用户登录**：如果未绑定手机号，登录后强制跳转到绑定页面
- **OAuth新用户**：必须先通过手机号注册，然后才能绑定OAuth账号
- **OAuth现有用户**：如果未绑定手机号，登录后强制跳转到绑定页面

### 2. 匿名用户访问admin数据（原有需求 - 必须保留）

#### 2.1 核心原则
- **匿名用户可以访问系统**：未登录用户可以访问系统，查看admin用户（id=1）的数据
- **只读权限**：匿名用户只能读取数据，不能进行写入操作
- **数据隔离**：匿名用户访问的是id=1用户的数据，登录用户访问自己的数据

#### 2.2 实现方式
- 使用 `AnonymousReadOnlyPermission` 权限类：允许匿名用户读取数据
- 使用 `AnonymousUserFilterBackend` 过滤器：匿名用户自动过滤id=1用户的数据
- 各个ViewSet中实现 `get_queryset()` 方法：匿名用户使用id=1用户的数据

#### 2.3 影响的API端点
- `/api/account/` - 账户管理（匿名用户访问id=1用户的账户）
- `/api/tags/` - 标签管理（匿名用户访问id=1用户的标签）
- `/api/expense/`、`/api/assets/`、`/api/income/` - 映射管理（匿名用户访问id=1用户的映射）
- `/api/templates/` - 模板管理（匿名用户只能查看官方模板）

### 3. 权限体系

#### 3.1 权限类说明
- `AnonymousReadOnlyPermission`：匿名用户只读，认证用户可读写
- `IsOwnerOrAdminReadWriteOnly`：只允许操作自己的数据，管理员有完全权限
- `IsOwnerOrReadOnly`：只能修改自己的数据，但可以读取所有数据
- `TemplatePermission`：模板权限（匿名用户只能查看官方模板）
- `PhoneNumberVerifiedPermission`（新增）：要求已验证手机号

#### 3.2 提示策略
- OAuth 及其它登录方式会直接返回 JWT，但若手机号未绑定，会通过响应中的 `phone_binding_required` 和 `warnings` 字段提示用户尽快绑定
- 前端路由守卫/拦截器会在需要时引导用户前往 `/phone-binding` 页面

## 设计约束

### 必须遵守的约束

1. **匿名用户访问必须保留**
   - 中间件不得拦截匿名用户请求
   - 匿名用户必须能够访问id=1用户的数据
   - 匿名用户权限是只读的

2. **手机号绑定检查**
   - 只检查已认证的用户
   - 匿名用户不需要绑定手机号
   - 已认证但未绑定手机号的用户会被拦截

3. **API路径规范**
   - 认证相关API：`/api/auth/*`
   - 业务API：`/api/{module}/*`
   - Allauth API：`/api/_allauth/*`

### 需要注意的问题

1. **路由守卫**
   - 前端路由守卫不应该阻止匿名用户访问
   - 只有已登录但未绑定手机号的用户才需要跳转到绑定页面

2. **权限检查顺序**
   - 中间件检查（已认证用户是否需要绑定手机号）
   - 权限类检查（是否有权限访问）
   - 过滤器应用（数据过滤）

3. **错误处理**
   - 403错误：手机号未绑定（`PHONE_NUMBER_REQUIRED`）
   - 401错误：未认证或token过期
   - 匿名用户访问只读数据应该返回200

## 测试要点

### 必须测试的场景

1. **匿名用户访问**
   - 未登录访问 `/api/account/` 应该返回id=1用户的数据
   - 未登录访问 `/api/tags/` 应该返回id=1用户的数据
   - 未登录用户不能进行POST/PUT/DELETE操作

2. **已认证用户手机号绑定检查**
   - 已登录但未绑定手机号访问业务API应该返回403
   - 已登录但未绑定手机号访问 `/api/auth/bindings/bind-phone/` 应该允许
   - 已绑定手机号的用户应该正常访问所有API

3. **登录流程**
   - 用户名/密码登录后检查手机号绑定状态
   - OAuth登录后检查手机号绑定状态
   - 未绑定手机号时自动跳转到绑定页面
