---
name: 修复映射模板账户关联问题
overview: 将 TemplateItem 模型的 account 字段从外键改为字符串（账户路径），修复应用模板时账户关联错误的问题，确保新用户的映射关联到自己的账户，而不是模板创建者的账户。
todos:
  - id: modify-model
    content: 修改 TemplateItem 模型：将 account 字段从 ForeignKey 改为 CharField，存储账户路径字符串
    status: pending
  - id: create-migration
    content: 创建数据迁移：将现有 account 外键数据转换为账户路径字符串
    status: pending
    dependencies:
      - modify-model
  - id: update-views
    content: 修改应用模板的视图方法：根据账户路径在目标用户账户中查找，添加缺失账户提示
    status: pending
    dependencies:
      - modify-model
  - id: update-serializers
    content: 修改 TemplateItemSerializer：适配 account 字段从外键到字符串的变更
    status: pending
    dependencies:
      - modify-model
  - id: update-init-command
    content: 修改初始化模板命令：直接使用账户路径字符串创建模板项，不再查找账户对象
    status: pending
    dependencies:
      - modify-model
  - id: test-changes
    content: 测试：验证模板应用逻辑，包括账户存在和不存在两种情况
    status: pending
    dependencies:
      - modify-model
      - create-migration
      - update-views
      - update-serializers
      - update-init-command
---

# 修复映射模板账户关联问题

## 问题分析

当前 `TemplateItem` 模型使用 `ForeignKey` 关联账户，导致以下问题：

1. 应用模板时，新用户的映射错误关联到模板创建者的账户对象
2. 如果新用户没有对应账户，缺少合理处理（应设置为 None 并提示）
3. 模板与特定用户的账户对象耦合，不利于模板共享

## 解决方案

将 `TemplateItem.account` 从 `ForeignKey(Account)` 改为 `CharField`，存储账户路径字符串（如 `"Expenses:Food:Dining"`）。应用模板时根据账户路径在目标用户的账户中查找并关联。

## 实施步骤

### 1. 修改模型定义

**文件**: [`Beancount-Trans-Backend/project/apps/maps/models.py`](Beancount-Trans-Backend/project/apps/maps/models.py)

- 将 `TemplateItem.account` 从 `ForeignKey(Account, ...)` 改为 `CharField(max_length=128, null=True, blank=True, help_text="映射账户路径")`
- 字段名保持不变为 `account`，但语义变为账户路径字符串

### 2. 创建数据迁移

**文件**: 新建迁移文件 `Beancount-Trans-Backend/project/apps/maps/migrations/0011_convert_templateitem_account_to_string.py`迁移逻辑：

- 将现有 `account` 外键转换为账户路径字符串：`item.account.account` → 新字段值
- 如果 `account` 为 None，则新字段也为 None
- 删除旧的外键字段，添加新的字符串字段

### 3. 修改应用模板的视图逻辑

**文件**: [`Beancount-Trans-Backend/project/apps/maps/views.py`](Beancount-Trans-Backend/project/apps/maps/views.py)修改三个应用方法：

- `_apply_expense_template` (417-461行)
- `_apply_income_template` (463-505行)  
- `_apply_assets_template` (507-549行)

**修改逻辑**：

```python
# 原代码：直接使用 item.account（模板创建者的账户对象）
expend=item.account

# 新代码：根据账户路径在目标用户账户中查找
target_account = None
if item.account:  # item.account 现在是账户路径字符串
    target_account = Account.objects.filter(
        account=item.account, 
        owner=self.request.user
    ).first()
    # 如果找不到，target_account 为 None，会正确设置为 null

Expense.objects.create(
    owner=self.request.user,
    key=item.key,
    payee=item.payee,
    expend=target_account,  # 可能是 None
    currency=item.currency
)
```

**返回信息增强**：

- 在 `result` 字典中添加 `missing_accounts` 列表，记录找不到对应账户的映射项
- 在响应中添加提示信息，告知用户哪些账户不存在

### 4. 修改序列化器

**文件**: [`Beancount-Trans-Backend/project/apps/maps/serializers.py`](Beancount-Trans-Backend/project/apps/maps/serializers.py)修改 `TemplateItemSerializer` (184-200行)：

- 移除 `account = AccountSummarySerializer(read_only=True)`
- 移除 `account_id = PrimaryKeyRelatedField(...)`
- `account` 字段改为普通 `CharField`，允许 null 和 blank

### 5. 修改初始化模板命令

**文件**: [`Beancount-Trans-Backend/project/apps/account/management/commands/init_official_templates.py`](Beancount-Trans-Backend/project/apps/account/management/commands/init_official_templates.py)修改创建 `TemplateItem` 的代码（约 803-812行, 849-857行, 889-897行）：

- 不再查找 `account_obj`
- 直接使用 `account_path` 字符串创建模板项：
```python
TemplateItem.objects.create(
    template=expense_template,
    key=key,
    payee=payee if payee else None,
    account=account_path,  # 直接使用账户路径字符串
    currency=currency
)
```




### 6. 更新 API 文档和类型定义

**文件**:

- [`Beancount-Trans-Backend/docs/api_schema.json`](Beancount-Trans-Backend/docs/api_schema.json) - 可能需要更新（如果使用 OpenAPI）
- 前端类型定义（如果需要）：`Beancount-Trans-Frontend/src/types/` 中相关的 TypeScript 接口

## 数据流变更

### 变更前

```javascript
TemplateItem.account (ForeignKey) 
  → 关联到模板创建者的 Account 对象
  → 应用时直接使用 item.account
  → 错误关联到模板创建者的账户
```



### 变更后

```javascript
TemplateItem.account (CharField: "Expenses:Food:Dining")
  → 存储账户路径字符串
  → 应用时根据路径查找目标用户的账户
  → 找到则关联，找不到则为 None
```



## 注意事项

1. **向后兼容性**：迁移需要安全处理现有数据，确保所有模板项的账户路径正确转换
2. **验证逻辑**：在序列化器中添加账户路径格式验证（可选，因为 Account 模型已有验证）
3. **前端适配**：前端可能需要调整显示逻辑，因为 `account` 字段从对象变为字符串
4. **测试覆盖**：确保测试覆盖账户存在和不存在两种情况

## 预期效果

- ✅ 新用户应用模板时，映射正确关联到自己的账户
- ✅ 如果账户不存在，账户字段为 None，并在响应中提示用户
- ✅ 模板不再与特定用户的账户对象耦合，可以安全共享