---
name: 测试资源清理机制
overview: 为测试用例添加完整的资源清理机制，确保测试后自动清理用户目录、Gitea 仓库、OSS/MinIO 文件等外部资源，防止测试资源泄漏。
todos:
  - id: create-test-utils
    content: 创建 TestResourceCleaner 工具类和测试资源清理方法
    status: pending
  - id: create-pytest-fixtures
    content: 创建 pytest fixtures（test_assets_dir、test_storage、cleanup_after_test 等）
    status: pending
    dependencies:
      - create-test-utils
  - id: update-test-settings
    content: 更新 test.py 配置，设置隔离的 Assets 目录和强制使用 local 存储
    status: pending
  - id: update-auth-tests
    content: 为 authentication 模块的测试用例添加资源清理机制
    status: pending
    dependencies:
      - create-pytest-fixtures
      - update-test-settings
  - id: update-git-tests
    content: 为 git_repository 模块的测试用例添加 Gitea 仓库清理机制
    status: pending
    dependencies:
      - create-pytest-fixtures
      - update-test-settings
  - id: update-file-tests
    content: 为 file_manager 模块的测试用例添加存储文件清理机制
    status: pending
    dependencies:
      - create-pytest-fixtures
      - update-test-settings
  - id: add-cleanup-tests
    content: 添加集成测试验证资源清理机制正常工作
    status: pending
    dependencies:
      - update-auth-tests
      - update-git-tests
      - update-file-tests
---

# 测试资源清理机制实现计划



## 问题分析

当前测试用例存在以下资源泄漏问题：

1. **用户目录泄漏**：创建用户时，`signals.py` 中的 `init_user_bean_structure_on_create` 会在 `Assets/{username}` 目录下创建文件结构，测试结束后未清理
2. **Gitea 仓库泄漏**：测试用例调用 `PlatformGitService.create_user_repository()` 创建远程仓库后未删除
3. **OSS/MinIO 文件泄漏**：测试用例上传文件到对象存储后未清理
4. **测试配置不隔离**：测试环境仍使用实际的 `Assets` 目录和可能的外部存储

## 解决方案

### 1. 创建测试资源清理工具类

创建 `Beancount-Trans-Backend/project/apps/common/test_utils.py`：

- **`TestResourceCleaner` 类**：统一管理测试资源清理
- `cleanup_user_directory(username)`：清理用户 Assets 目录
- `cleanup_gitea_repository(repo_name)`：删除 Gitea 远程仓库
- `cleanup_storage_files(storage_names)`：清理 OSS/MinIO 文件
- `cleanup_user_resources(user)`：清理用户的所有资源（目录、仓库、文件）
- `cleanup_all_test_resources()`：清理所有测试资源

### 2. 创建 pytest fixtures

创建 `Beancount-Trans-Backend/project/apps/common/conftest.py`：

- **`test_assets_dir` fixture**：为测试提供隔离的临时 Assets 目录
- **`test_storage` fixture**：为测试提供隔离的存储配置（强制使用 local）
- **`cleanup_after_test` fixture**：自动清理测试资源（teardown）
- **`test_user_with_cleanup` fixture**：创建测试用户并自动清理

### 3. 更新测试配置

修改 `Beancount-Trans-Backend/project/settings/test.py`：

- 设置测试专用的 `ASSETS_BASE_PATH`（使用临时目录）
- 强制 `STORAGE_TYPE = 'local'`（覆盖环境变量）
- 添加测试资源追踪配置

### 4. 更新现有测试用例

为以下测试文件添加清理机制：

- `Beancount-Trans-Backend/project/apps/authentication/tests/test_*.py`：所有认证相关测试
- `Beancount-Trans-Backend/project/apps/git_repository/tests/test_*.py`：Git 仓库测试
- `Beancount-Trans-Backend/project/apps/file_manager/tests/test_*.py`：文件管理测试

### 5. 添加测试中间件保护

在测试环境中：

- 拦截所有可能创建外部资源的操作
- 记录所有创建的资源（用户目录、Gitea 仓库、存储文件）
- 测试结束后自动清理记录的资源

## 实施步骤

1. **创建测试工具类**：实现 `TestResourceCleaner` 和 pytest fixtures
2. **更新测试配置**：修改 `test.py` 确保资源隔离
3. **更新测试用例**：为现有测试添加清理机制
4. **添加集成测试**：验证清理机制正常工作
5. **文档更新**：更新测试文档说明资源清理机制

## 关键文件

- `Beancount-Trans-Backend/project/apps/common/test_utils.py`（新建）
- `Beancount-Trans-Backend/project/apps/common/conftest.py`（新建）
- `Beancount-Trans-Backend/project/settings/test.py`（修改）
- `Beancount-Trans-Backend/project/apps/authentication/tests/test_*.py`（修改）
- `Beancount-Trans-Backend/project/apps/git_repository/tests/test_*.py`（修改）
- `Beancount-Trans-Backend/project/apps/file_manager/tests/test_*.py`（修改）

## 注意事项

1. **向后兼容**：确保现有测试用例在添加清理机制后仍能正常运行
2. **性能考虑**：清理操作不应显著影响测试执行速度