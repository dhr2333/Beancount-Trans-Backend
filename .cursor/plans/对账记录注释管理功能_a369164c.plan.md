---
name: 对账记录注释管理功能
overview: 实现平台对账记录的注释管理功能，支持通过 Beancount 库匹配对账条目，在 Git 同步时检测重复并注释匹配的条目，删除 Git 仓库时取消所有注释。
todos:
  - id: create_entry_matcher
    content: 创建 EntryMatcher 服务类，实现 Beancount 条目的解析和匹配逻辑
    status: pending
  - id: create_comment_service
    content: 创建 ReconciliationCommentService 服务类，实现对账条目的注释管理功能
    status: pending
    dependencies:
      - create_entry_matcher
  - id: integrate_git_sync
    content: 在 Git 同步流程中集成重复检测逻辑，同步完成后返回检测结果
    status: pending
    dependencies:
      - create_comment_service
  - id: add_reconciliation_apis
    content: 添加对账注释管理的 API 端点（检测重复、注释条目、取消注释）
    status: pending
    dependencies:
      - create_comment_service
  - id: integrate_git_delete
    content: 在 Git 仓库删除流程中集成取消注释逻辑
    status: pending
    dependencies:
      - create_comment_service
  - id: add_tests
    content: 添加单元测试和集成测试，覆盖匹配逻辑、注释操作和边界情况
    status: pending
    dependencies:
      - create_entry_matcher
      - create_comment_service
---

# 对账记录注释管理功能实现计划

## 一、需求分析

### 1.1 核心业务流程

**用户对账流程**：

```javascript
用户在平台完成对账
    ↓
平台生成 Beancount 格式文本
    ↓
追加到 trans/reconciliation.bean 文件（平台管理，不在 Git 中）
    ↓
用户想要自行管理数据
    ↓
开启 Git 功能
    ↓
用户手动复制平台记录到 Git 仓库（复制到年度目录、main.bean 等）
    ↓
用户提交到 Git 仓库（trans/ 目录被 .gitignore 忽略）
    ↓
平台自动拉取 Git 仓库数据到服务器本地
    ↓
完整账本 = Git 仓库数据 + 平台管理的 trans/ 目录
    ↓
通过 Fava 启动用户账本（加载完整账本）
```

**重要理解**：

- **`trans/` 目录被 Git 忽略**：`.gitignore` 中配置了 `trans/`，该目录不会被提交到 Git 仓库
- **完整账本结构**：
  ```javascript
    用户账本目录/
    ├── main.bean              (Git 仓库)
    ├── account/                (Git 仓库)
    ├── 2024/                   (Git 仓库)
    │   └── *.bean
    └── trans/                   (平台管理，不在 Git 中)
        ├── main.bean
        ├── reconciliation.bean
        └── *.bean
  ```


**冲突场景**：

- 平台写入的文本：`trans/reconciliation.bean`（平台管理，不在 Git 中）
- 用户复制平台记录到 Git 仓库：用户将 `trans/reconciliation.bean` 中的记录复制到 Git 仓库的其他位置（如年度目录、main.bean 等）
- 平台拉取 Git 数据：Git 仓库数据被拉取到服务器本地，与 `trans/` 目录合并
- **问题**：两份相同的对账记录（Git 仓库中的 + `trans/reconciliation.bean` 中的）会导致 Fava 报表中数据重复

### 1.2 核心需求

**解决冲突的机制**：

1. **自动检测**：Git 同步完成后，平台拉取 Git 仓库数据到服务器本地，然后检测**Git 仓库数据（除 trans/ 目录外）**与平台 `trans/reconciliation.bean` 的记录是否冲突
2. **自动注释**：如果检测到重复，自动注释平台 `trans/reconciliation.bean` 文件中的对应记录
3. **避免重复**：通过注释机制，确保 Fava 报表中只显示 Git 仓库中的版本，避免数据重复

**检测范围说明**：

- **平台文件**：`trans/reconciliation.bean` 中的所有对账条目
- **Git 仓库数据**：平台拉取到服务器本地的 Git 仓库数据（**不包含 trans/ 目录**，因为 trans/ 被 .gitignore 忽略）
- **检测逻辑**：比较 Git 仓库中的对账条目（可能在年度目录、main.bean 等位置）与 `trans/reconciliation.bean` 中的条目

**完整闭环流程**：

```mermaid
flowchart TD
    A[用户在平台完成对账] --> B[平台写入 trans/reconciliation.bean<br/>trans/目录被Git忽略]
    B --> C{用户是否需要自行管理数据?}
    C -->|否| D[平台继续管理，Fava正常显示]
    C -->|是| E[用户复制平台记录到Git仓库<br/>复制到年度目录/main.bean等]
    E --> F[用户提交到Git<br/>trans/目录被忽略，不提交]
    F --> G[平台自动拉取Git数据到服务器本地]
    G --> H[完整账本 = Git仓库数据 + trans/目录]
    H --> I[Git同步完成，自动检测重复条目]
    I --> J{发现重复?<br/>Git仓库数据 vs trans/reconciliation.bean}
    J -->|是| K[自动注释 trans/reconciliation.bean<br/>中的匹配条目]
    J -->|否| L[保持现状]
    K --> M[Fava显示Git版本，避免重复]
    L --> M
    M --> N{用户删除Git仓库?}
    N -->|是| O[自动取消所有注释<br/>恢复平台管理]
    N -->|否| P[继续使用Git版本]
    O --> Q[恢复平台管理，Fava显示平台版本]
    
    style K fill:#e1f5ff
    style O fill:#fff4e1
    style M fill:#e8f5e9
    style H fill:#fff9c4
```

**关键场景处理**：

- ✅ **场景1**：用户完成对账 → 平台写入 `trans/reconciliation.bean` 
- ✅ **场景2**：用户复制到Git（年度目录/main.bean等） → 平台拉取Git数据 → 检测到重复 → 自动注释 `trans/reconciliation.bean`
- ✅ **场景3**：用户删除Git仓库 → 平台取消注释 → 恢复平台管理 
- ✅ **场景4**：用户修改Git记录 → 平台检测到差异 → 不注释（保持用户版本）
- ✅ **场景5**：用户新增对账 → 平台写入新记录到 `trans/reconciliation.bean` → 如果Git中不存在则保持未注释状态

### 1.3 核心功能

1. **对账条目匹配**：使用 Beancount 库解析并匹配 Transaction、Pad、Balance 指令
2. **注释管理**：为匹配的对账条目添加/移除注释（`;` 前缀）
3. **Git 同步检测**：同步完成后自动检测重复条目并注释
4. **Git 仓库删除**：删除 Git 仓库时取消所有对账条目的注释

### 1.4 数据所有权策略

- **平台数据**：`trans/` 中的所有文件由平台管理
- **用户数据**：`trans/` 目录外的其他文件由用户通过 Git 管理
- **迁移机制**：用户将平台数据迁移到**用户数据**后，平台通过注释**平台数据中的记录**避免重复

## 二、技术架构

### 2.1 核心服务设计

#### ReconciliationCommentService（新增）

负责对账条目的注释管理：

- `match_reconciliation_entries()`: 匹配对账条目
- `comment_matched_entries()`: 注释匹配的条目
- `uncomment_all_entries()`: 取消所有注释
- `detect_duplicate_entries()`: 检测重复条目

#### EntryMatcher（新增）

负责 Beancount 条目的匹配逻辑：

- `normalize_entry()`: 标准化条目（去除格式差异）
- `match_transaction()`: 匹配 Transaction 指令
- `match_pad()`: 匹配 Pad 指令
- `match_balance()`: 匹配 Balance 指令

### 2.2 匹配规则

**允许的格式差异**：

- 注释位置和数量
- 空行和缩进
- 账户名称的格式（如 `Assets:Savings:Bank:ICBC` vs `Assets:Savings:Bank:ICBC `）
- 金额格式（如 `1000.00` vs `1000` vs `1000.0`）
- Transaction 的 Narration（描述文本）

**不允许的差异**：

- 日期不同
- 账户不同
- 金额数值不同
- 币种不同
- Payee 不同（Transaction）

### 2.3 文件操作

**注释策略**：

- 只注释匹配的单个指令行（Transaction、Pad 或 Balance）
- 保留文件的其他内容不变
- 注释格式：在行首添加 `;` 前缀

## 三、实现步骤

### 步骤 1：创建条目匹配服务

**文件**：`Beancount-Trans-Backend/project/apps/reconciliation/services/entry_matcher.py`**功能**：

- 使用 Beancount 库解析 `.bean` 文件
- 提取 Transaction、Pad、Balance 条目
- 实现条目标准化和匹配逻辑
- 支持格式差异的容错匹配

**关键方法**：

```python
class EntryMatcher:
    @staticmethod
    def normalize_transaction(entry) -> Dict:
        """标准化 Transaction 条目，提取核心字段"""
        
    @staticmethod
    def normalize_pad(entry) -> Dict:
        """标准化 Pad 条目"""
        
    @staticmethod
    def normalize_balance(entry) -> Dict:
        """标准化 Balance 条目"""
        
    @staticmethod
    def match_entries(entries1: List, entries2: List) -> List[Tuple]:
        """匹配两组条目，返回匹配对列表"""
```



### 步骤 2：创建注释管理服务

**文件**：`Beancount-Trans-Backend/project/apps/reconciliation/services/reconciliation_comment_service.py`**功能**：

- 读取 `trans/reconciliation.bean` 文件（平台管理，不在 Git 中）
- 解析文件内容，识别对账条目
- 解析 Git 仓库数据中的对账条目（已拉取到服务器本地，不包含 `trans/` 目录）
- 匹配重复条目并注释 `trans/reconciliation.bean` 中的对应记录
- 取消注释功能（删除 Git 仓库时使用）

**关键方法**：

```python
class ReconciliationCommentService:
    @staticmethod
    def detect_and_comment_duplicates(user) -> Dict:
        """检测并自动注释重复条目（Git同步时调用）
        
        流程：
                                1. 解析 trans/reconciliation.bean 中的所有对账条目（平台管理）
                                2. 解析 Git 仓库数据中的所有 .bean 文件的对账条目
                                            - Git 仓库数据已拉取到服务器本地用户目录
                                            - Git 仓库中不包含 trans/ 目录（因为被 .gitignore 忽略）
                                            - 遍历用户目录中除 trans/ 外的所有 .bean 文件
                                3. 匹配重复条目
                                4. 自动注释 trans/reconciliation.bean 中匹配的条目
                                5. 返回注释结果
        
        Returns:
            {
                'commented_count': 5,
                'matched_entries': [...],
                'message': '已注释 5 个重复条目'
            }
        """
        
    @staticmethod
    def detect_duplicate_entries(user) -> Dict:
        """仅检测重复条目，不执行注释（用于前端展示）
        
        检测逻辑：
                                - 比较 Git 仓库数据（已拉取到服务器本地）与 trans/reconciliation.bean 的条目
                                - Git 仓库中不包含 trans/ 目录（因为被忽略）
        
        Returns:
            {
                'has_duplicates': True,
                'duplicate_count': 5,
                'duplicates': [...]
            }
        """
        
    @staticmethod
    def comment_matched_entries(user, matched_entries: List) -> int:
        """注释匹配的条目，返回注释数量（手动调用）"""
        
    @staticmethod
    def uncomment_all_entries(user) -> int:
        """取消所有对账条目的注释，返回取消注释数量（删除Git仓库时调用）"""
```



### 步骤 3：集成到 Git 同步流程

**文件**：`Beancount-Trans-Backend/project/apps/git_repository/services.py`**修改点**：

- 在 `sync_repository()` 方法中，同步完成后自动调用检测逻辑
- Git 仓库数据已拉取到服务器本地用户目录（不包含 `trans/` 目录，因为被忽略）
- 如果检测到重复条目，**自动注释**平台 `trans/reconciliation.bean` 中的对应记录
- 返回注释结果信息，供前端展示

**流程**：

```mermaid
sequenceDiagram
    participant User as 用户
    participant Git as Git同步服务
    participant Detect as 重复检测服务
    participant Comment as 注释服务
    participant File as reconciliation.bean

    User->>Git: 触发Git同步
    Git->>Git: 拉取远程仓库数据到服务器本地<br/>Git仓库数据不包含trans/目录
    Git->>Detect: 同步完成，自动检测重复条目
    Detect->>Detect: 解析Git仓库数据中的对账记录<br/>遍历用户目录中除trans/外的.bean文件
    Detect->>Detect: 解析trans/reconciliation.bean<br/>平台管理的文件
    Detect->>Detect: 匹配重复条目
    Detect->>Comment: 发现重复，自动注释
    Comment->>File: 注释trans/reconciliation.bean中匹配的条目行
    Comment-->>Git: 返回注释结果
    Git-->>User: 返回同步结果（包含注释信息）
```

**关键逻辑**：

- Git 同步完成后，Git 仓库数据已拉取到服务器本地用户目录
- `trans/` 目录不在 Git 仓库中（被 `.gitignore` 忽略），所以 Git 仓库数据本身就不包含 `trans/`
- 检测逻辑：比较 Git 仓库数据中的对账条目 vs `trans/reconciliation.bean` 中的条目
- 同步完成后立即检测并**自动注释**匹配的条目，无需用户确认
- 记录注释操作日志，便于追踪

### 步骤 4：添加注释管理 API

**文件**：`Beancount-Trans-Backend/project/apps/reconciliation/views.py`**新增 Action**：

- `check_duplicates`: 检测重复条目（GET）
- `comment_duplicates`: 注释重复条目（POST）
- `uncomment_all`: 取消所有注释（POST）

**序列化器**：

- `ReconciliationDuplicateSerializer`: 重复条目信息
- `ReconciliationCommentResponseSerializer`: 注释操作响应

### 步骤 5：集成到 Git 仓库删除流程

**文件**：`Beancount-Trans-Backend/project/apps/git_repository/services.py`**修改点**：

- 在 `delete_user_repository()` 方法中，删除前调用取消注释逻辑
- 确保所有对账条目取消注释后再删除 Git 仓库

### 步骤 6：文件解析和注释实现

**关键技术点**：

1. **文件解析**：使用 Beancount `loader.load_file()` 解析文件
2. **行号映射**：建立 Beancount 条目与文件行号的映射关系
3. **注释操作**：直接操作文件内容，在对应行首添加/移除 `;`
4. **格式保持**：保持文件原有格式（缩进、空行等）

**实现难点**：

- Beancount 解析后的条目可能跨多行，需要准确映射到文件行号
- 注释操作需要保持文件格式不变
- 处理已注释条目的重复检测

## 四、API 设计

### 4.1 检测重复条目

**端点**：`GET /api/reconciliation/check-duplicates/`**响应**：

```json
{
  "has_duplicates": true,
  "duplicate_count": 5,
  "duplicates": [
    {
      "type": "Transaction",
      "date": "2026-01-24",
      "account": "Assets:Savings:Web:WechatFund",
      "amount": "3.00",
      "currency": "CNY",
      "line_number": 70
    }
  ]
}
```



### 4.2 注释重复条目

**端点**：`POST /api/reconciliation/comment-duplicates/`**请求体**：

```json
{
  "entry_line_numbers": [70, 71, 72]
}
```

**响应**：

```json
{
  "commented_count": 3,
  "message": "已注释 3 个重复条目"
}
```



### 4.3 取消所有注释

**端点**：`POST /api/reconciliation/uncomment-all/`**响应**：

```json
{
  "uncommented_count": 10,
  "message": "已取消 10 个条目的注释"
}
```



### 4.4 Git 同步响应增强

**端点**：`POST /api/git/sync/`**响应增强**：

```json
{
  "status": "success",
  "message": "同步成功",
  "synced_at": "2026-01-24T10:30:00Z",
  "reconciliation_comment_result": {
    "commented_count": 5,
    "message": "已自动注释 5 个重复的对账条目",
    "matched_entries": [
      {
        "type": "Transaction",
        "date": "2026-01-24",
        "account": "Assets:Savings:Web:WechatFund",
        "line_number": 70
      }
    ]
  }
}
```

**说明**：

- 同步完成后自动检测并注释重复条目
- 返回注释结果，前端可展示提示信息
- 如果无重复条目，`reconciliation_comment_result` 字段为 `null`

## 五、测试计划

### 5.1 单元测试

- `EntryMatcher` 的匹配逻辑测试
- `ReconciliationCommentService` 的注释操作测试
- 格式差异容错测试

### 5.2 集成测试

- Git 同步后检测流程测试
- Git 仓库删除时取消注释测试
- 文件格式保持测试

### 5.3 边界情况

- 空文件处理
- 已注释条目的重复检测
- 部分匹配场景（Transaction 匹配但 Balance 不匹配）

## 六、实现细节

### 6.1 重复检测范围

**重要前提**：

- **`trans/` 目录被 Git 忽略**：`.gitignore` 中配置了 `trans/`，该目录不会被提交到 Git 仓库
- **完整账本结构**：用户账本目录 = Git 仓库数据（已拉取到本地）+ 平台管理的 `trans/` 目录
- **Git 仓库中不包含 `trans/`**：因为被忽略，所以 Git 仓库中本身就没有 `trans/` 目录

**检测范围**：

- **平台文件**：`trans/reconciliation.bean` 中的所有对账条目（平台管理，不在 Git 中）
- **Git 仓库数据**：平台拉取到服务器本地的 Git 仓库数据中的所有 `.bean` 文件
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 包括：`main.bean`、年度目录下的 `.bean` 文件、`account/` 目录下的文件等
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - **注意**：Git 仓库中本身就不包含 `trans/` 目录（因为被忽略），所以不需要排除

**检测逻辑**：

```python
# 1. 解析 trans/reconciliation.bean（平台管理的文件）
reconciliation_path = BeanFileManager.get_reconciliation_bean_path(user)
platform_entries = parse_bean_file(reconciliation_path)

# 2. 解析 Git 仓库数据（已拉取到服务器本地）
# Git 仓库数据在用户目录中，但不包含 trans/ 目录（因为被忽略）
user_assets_path = BeanFileManager.get_user_assets_path(user)
git_entries = []

# 遍历用户目录中的所有 .bean 文件（不包括 trans/）
for bean_file in user_assets_path.rglob('*.bean'):
    # trans/ 目录不在 Git 仓库中，所以这里遍历到的都是 Git 仓库的文件
    # 但为了安全，仍然排除 trans/ 目录
    if 'trans/' in str(bean_file.relative_to(user_assets_path)):
        continue
    entries = parse_bean_file(bean_file)
    git_entries.extend(entries)

# 3. 匹配重复条目
matched = match_entries(platform_entries, git_entries)

# 4. 注释匹配的条目（注释 trans/reconciliation.bean 中的条目）
comment_entries(user, matched)
```

**关键点**：

- Git 同步后，Git 仓库数据被拉取到服务器本地的用户目录
- `trans/` 目录是平台管理的，不在 Git 仓库中
- 检测的是：Git 仓库数据中的对账条目 vs `trans/reconciliation.bean` 中的条目
- 如果用户复制了对账记录到 Git 仓库（如年度目录），则会被检测到并注释平台记录

### 6.2 匹配策略

**匹配原则**：

- 只匹配对账相关的条目类型：Transaction、Pad、Balance
- 允许格式差异（空格、缩进、金额格式）
- 核心字段必须完全匹配（日期、账户、金额、币种）

**匹配示例**：

```beancount
# 平台文件中的记录
2026-01-24 * "Beancount-Trans" "对账调整"
    Income:Active:Freelance -3.00 CNY
    Assets:Savings:Web:WechatFund

# Git 仓库中的记录（格式不同但内容相同）
2026-01-24 * "Beancount-Trans" "对账调整"
    Income:Active:Freelance  -3.00 CNY
    Assets:Savings:Web:WechatFund

# ✅ 匹配成功，注释平台记录
```



### 6.3 注释操作

**注释格式**：

```beancount
# 平台文件中的记录

# 注释前
2026-01-24 * "Beancount-Trans" "对账调整"
    Income:Active:Freelance -3.00 CNY
    Assets:Savings:Web:WechatFund

# 注释后
; 2026-01-24 * "Beancount-Trans" "对账调整"
;     Income:Active:Freelance -3.00 CNY
;     Assets:Savings:Web:WechatFund
```

**注意事项**：

- 只注释匹配的条目行，保留文件其他内容
- 保持文件原有格式（缩进、空行）
- 已注释的条目不再参与匹配

## 七、注意事项

1. **性能考虑**：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Git 仓库可能包含大量文件，需要优化解析性能
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 使用缓存机制，避免重复解析
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 异步处理大型仓库的检测

2. **错误处理**：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Beancount 解析失败时的降级策略
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 文件读写异常的处理

3. **并发安全**：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 文件操作时的锁机制
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Git 同步与对账操作的并发控制

4. **用户提示**：

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 清晰的前端提示，说明注释的含义和影响
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 告知用户注释后的数据变化
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 提供取消注释的选项（删除 Git 仓库时自动取消）

5. **数据一致性**：