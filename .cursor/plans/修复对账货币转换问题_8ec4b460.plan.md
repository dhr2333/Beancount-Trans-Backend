---
name: 修复对账货币转换问题
overview: 当对账账户是 COIN 货币，而 transaction 记录中的目标账户（如 Expenses:Food:Dinner）不支持 COIN 货币时，自动获取目标账户支持的货币（优先 CNY），并使用 Beancount 的 `@@` 语法进行货币转换。
todos:
  - id: create_currency_service
    content: 创建 account_currency_service.py，实现账户货币解析和选择逻辑
    status: completed
  - id: modify_transaction_directive
    content: 修改 _generate_transaction_directive 方法，添加货币转换逻辑
    status: completed
    dependencies:
      - create_currency_service
  - id: update_call_sites
    content: 更新 execute_reconciliation 方法中的调用，传递 user 参数
    status: completed
    dependencies:
      - modify_transaction_directive
---

# 修复对账货币转换问题

## 问题描述

当对账账户是 COIN 货币，而 transaction 记录中的目标账户（如 `Expenses:Food:Dinner`）不支持 COIN 货币时，当前实现会直接使用 COIN 货币，导致 Beancount 报错。需要：

1. 获取目标账户支持的所有货币
2. 如果有 CNY，默认使用 CNY
3. 否则取第一个货币
4. 使用 Beancount 的 `@@` 语法进行货币转换

## 实现方案

### 1. 创建账户货币解析工具

在 `Beancount-Trans-Backend/project/apps/reconciliation/services/` 中创建新文件 `account_currency_service.py`，提供以下功能：

- `get_account_currencies(user, account_name: str) -> Optional[List[str]]`: 解析 Beancount 账本文件，获取账户在 `open` 指令中声明的所有货币
- 解析用户账本目录下的所有 `.bean` 文件
- 查找匹配账户名称的 `open` 指令
- 如果 `open` 指令没有声明货币（格式：`YYYY-MM-DD open Account:Name`），返回 `None`（表示支持所有货币）
- 如果 `open` 指令声明了货币（单货币或多货币），提取货币列表并返回
- 如果没有找到账户的 `open` 指令，返回空列表 `[]`（表示账户不存在）
- `select_currency_for_account(user, account_name: str, source_currency: str) -> str`: 为目标账户选择合适的货币
- 获取账户支持的所有货币（调用 `get_account_currencies`）
- 如果返回 `None`（账户支持所有货币），直接返回源货币
- 如果返回空列表（账户不存在），返回源货币（保持原有行为，避免报错）
- 如果返回货币列表：
    - 如果源货币在支持列表中，返回源货币
    - 否则，优先返回 CNY（如果存在）
    - 如果不存在 CNY，返回第一个货币

### 2. 修改 transaction 指令生成逻辑

修改 `Beancount-Trans-Backend/project/apps/reconciliation/services/reconciliation_service.py` 中的 `_generate_transaction_directive` 方法：

- 添加 `user` 参数（用于访问账本文件）
- 调用 `select_currency_for_account` 获取目标账户的合适货币
- 如果目标货币与源货币不同，使用 Beancount 的 `@@` 语法：
  ```javascript
        {to_account} {amount} {target_currency} @@ {abs(amount)} {source_currency}
  ```




- 注意：`@@` 后面的金额使用绝对值（`abs(amount)`），即使原金额是负数
- 例如：`Expenses:Food:Dinner -68.00 CNY @@ 68.00 COIN`
- 如果目标货币与源货币相同（包括账户支持所有货币的情况），使用原有格式（不需要 `@@` 语法）

### 3. 更新调用点

修改 `execute_reconciliation` 方法中调用 `_generate_transaction_directive` 的地方：

- 传递 `user` 参数（从 `task.content_object.owner` 获取）
- 确保所有调用都包含用户信息

## 文件变更

1. **新建文件**: `Beancount-Trans-Backend/project/apps/reconciliation/services/account_currency_service.py`

- 实现账户货币解析和选择逻辑

2. **修改文件**: `Beancount-Trans-Backend/project/apps/reconciliation/services/reconciliation_service.py`

- 修改 `_generate_transaction_directive` 方法签名和实现
- 更新 `execute_reconciliation` 方法中的调用

## 技术细节

### Beancount open 指令格式

支持所有货币（无货币声明）：

```beancount
YYYY-MM-DD open Account:Name
```

单货币：

```beancount
YYYY-MM-DD open Account:Name Currency
```

多货币：

```beancount
YYYY-MM-DD open Account:Name Currency1, Currency2, ...
```

**重要**：如果 `open` 指令没有声明货币，表示该账户支持所有货币，可以直接使用源货币（对账账户的货币），无需货币转换。

### 货币转换语法

正数金额：

```beancount
Expenses:Food:Dinner 68.00 CNY @@ 68.00 COIN
```

负数金额（`@@` 后使用绝对值）：

```beancount
Expenses:Food:Dinner -68.00 CNY @@ 68.00 COIN
```



### 解析策略

- 遍历用户账本目录下的所有 `.bean` 文件
- 使用正则表达式匹配 `open` 指令
- 提取账户名称和货币列表
- 缓存解析结果（可选，提升性能）

## 测试考虑

- 测试账户支持所有货币的情况（`open` 指令无货币声明）
- 应直接使用源货币，无需 `@@` 转换
- 测试账户支持单货币的情况
- 测试账户支持多货币的情况
- 测试账户未找到的情况（返回空列表，应使用源货币）
- 测试源货币在支持列表中的情况
- 应直接使用源货币，无需 `@@` 转换
- 测试源货币不在支持列表中，但有 CNY 的情况
- 应使用 CNY，需要 `@@` 转换
- 测试源货币不在支持列表中，且没有 CNY 的情况