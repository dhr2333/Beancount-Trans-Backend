---
name: 对账功能测试用例计划
overview: 为 Beancount-Trans 对账功能制定完整的 pytest 单元测试用例计划，覆盖模型、服务、API 等核心功能点
todos:
  - id: test-1
    content: 创建测试目录结构和 conftest.py，定义所有测试 fixtures（user, account, scheduled_task, bean_file_manager 等）
    status: pending
  - id: test-2
    content: 编写 test_models.py - ScheduledTask 模型测试（创建、字段验证、方法、约束）
    status: pending
    dependencies:
      - test-1
  - id: test-3
    content: 编写 test_services_cycle.py - CycleCalculator 周期计算服务测试（基础计算、月末边界、跨年边界）
    status: pending
    dependencies:
      - test-1
  - id: test-4
    content: 编写 test_services_balance.py - BalanceCalculationService 余额计算服务测试（单币种、多币种、边界情况）
    status: pending
    dependencies:
      - test-1
  - id: test-5
    content: 编写 test_services_reconciliation.py - 对账执行服务测试（无差额、有差额三种场景、多币种、创建下一个待办）
    status: pending
    dependencies:
      - test-1
      - test-3
      - test-4
  - id: test-6
    content: 编写 test_serializers.py - 序列化器测试（ScheduledTaskSerializer、ReconciliationStartSerializer、ReconciliationExecuteSerializer）
    status: pending
    dependencies:
      - test-1
  - id: test-7
    content: 编写 test_validators.py - 验证器测试（对账执行验证器）
    status: pending
    dependencies:
      - test-1
  - id: test-8
    content: 编写 test_views_tasks.py - 待办管理 API 测试（列表、详情、修改日期、取消、权限）
    status: pending
    dependencies:
      - test-1
      - test-2
      - test-6
  - id: test-9
    content: 编写 test_views_reconciliation.py - 对账执行 API 测试（开始对账、执行对账所有场景、多币种、错误处理）
    status: pending
    dependencies:
      - test-1
      - test-5
      - test-6
      - test-7
  - id: test-10
    content: 编写 test_integration.py - 集成测试（完整对账流程、周期配置变更流程）
    status: pending
    dependencies:
      - test-8
      - test-9
---

# 对账功能测试用例计划

## 测试目标

为 `Beancount-Trans-Backend/project/apps/reconciliation` 模块制定完整的 pytest 单元测试用例，覆盖以下核心功能：

1. **通用待办模型** (`ScheduledTask`)
2. **周期计算服务** (`CycleCalculator`)
3. **余额计算服务** (`BalanceCalculationService`)
4. **对账执行服务** (差额处理、指令生成)
5. **API 端点** (待办管理、对账执行)
6. **边界情况** (月末边界、多币种、周期配置变更)

## 测试文件结构

```javascript
Beancount-Trans-Backend/project/apps/reconciliation/
├── tests/
│   ├── __init__.py
│   ├── conftest.py                    # pytest fixtures
│   ├── test_models.py                 # ScheduledTask 模型测试
│   ├── test_services_cycle.py         # CycleCalculator 服务测试
│   ├── test_services_balance.py        # BalanceCalculationService 测试
│   ├── test_services_reconciliation.py # 对账执行服务测试
│   ├── test_serializers.py            # 序列化器测试
│   ├── test_validators.py             # 验证器测试
│   ├── test_views_tasks.py             # 待办管理 API 测试
│   ├── test_views_reconciliation.py    # 对账执行 API 测试
│   └── test_integration.py            # 集成测试（可选）
```



## 测试用例详细规划

### 1. conftest.py - 测试 Fixtures

**重要说明**：pytest 的 `conftest.py` 采用层级继承机制，多个 `conftest.py` 文件可以共存且不冲突：

- **根目录 `Beancount-Trans-Backend/conftest.py`**（已存在）：
- 提供全局清理功能（`cleanup_test_assets_per_function`、`cleanup_test_assets_session`）
- 自动清理测试创建的 Assets 目录
- **保持不变，继续使用**
- **模块目录 `reconciliation/tests/conftest.py`**（新建）：
- 提供该模块特定的测试 fixtures
- 自动继承根目录的 fixtures（清理功能）
- 只定义对账模块需要的测试数据

**职责**：提供可复用的测试数据和工具函数**需要创建的 fixtures**：

- `user` - 测试用户（使用 `get_user_model()`）
- `account` - 测试账户（带/不带对账周期配置）
- `account_with_cycle` - 带对账周期的账户
- `scheduled_task` - 待办任务（不同状态：pending, completed, cancelled）
- `scheduled_task_pending` - 待执行的待办
- `scheduled_task_completed` - 已完成的待办
- `bean_file_manager` - BeanFileManager mock（使用 `unittest.mock.Mock`）
- `beancount_loader` - beancount.loader mock
- `reconciliation_settings` - 用户对账配置（如果存在 ReconciliationSettings 模型）
- `mock_bean_content` - Mock Beancount 账本内容（多币种场景）

### 2. test_models.py - ScheduledTask 模型测试

**测试用例**：

#### 2.1 模型创建与字段验证

- [ ] 创建对账类型待办（task_type='reconciliation'）
- [ ] 验证 content_type 和 object_id 关联账户
- [ ] 验证 scheduled_date 和 completed_date 字段
- [ ] 验证 status 字段默认值为 'pending'
- [ ] 验证 status 字段选择（pending, completed, cancelled）

#### 2.2 模型方法测试

- [ ] `__str__` 方法返回正确格式
- [ ] `is_overdue` 方法（scheduled_date < today 且 status=pending）
- [ ] `mark_completed` 方法（更新 status 和 completed_date）

#### 2.3 模型约束测试

- [ ] 同一账户同一日期不能完成两次待办

### 3. test_services_cycle.py - 周期计算服务测试

**测试用例**：

#### 3.1 基础周期计算

- [ ] 每 N 天：1 月 1 日 + 15 天 = 1 月 16 日
- [ ] 每 N 周：1 月 1 日 + 2 周 = 1 月 15 日
- [ ] 每 N 月：1 月 1 日 + 1 月 = 2 月 1 日
- [ ] 每 N 年：2025-01-01 + 1 年 = 2026-01-01

#### 3.2 月末边界情况

- [ ] 1 月 31 日 + 1 月 = 2 月 28 日（非闰年）
- [ ] 1 月 31 日 + 1 月 = 2 月 29 日（闰年）
- [ ] 1 月 30 日 + 1 月 = 2 月 28 日（非闰年）
- [ ] 3 月 31 日 + 1 月 = 4 月 30 日（不存在 4 月 31 日）

#### 3.3 跨年边界

- [ ] 12 月 31 日 + 1 月 = 次年 1 月 31 日
- [ ] 12 月 1 日 + 2 月 = 次年 2 月 1 日

#### 3.4 周期计算器方法测试

- [ ] `calculate_next_date` 方法正确计算下一个日期
- [ ] 传入 None 或无效周期单位时抛出异常
- [ ] 间隔为 0 或负数时抛出异常

### 4. test_services_balance.py - 余额计算服务测试

**测试用例**：

#### 4.1 单币种余额计算

- [ ] 计算账户 CNY 余额（正常情况）
- [ ] 计算账户余额（账户不存在时返回 0）
- [ ] 计算账户余额（账本文件不存在时抛出异常）

#### 4.2 多币种余额计算

- [ ] 计算账户多币种余额（CNY, COIN 等）
- [ ] 计算指定币种余额（currency='CNY'）
- [ ] 计算指定币种余额（currency='COIN'）
- [ ] 币种不存在时返回 0

#### 4.3 余额计算边界情况

- [ ] 空账本文件（无交易记录）
- [ ] 账户无余额（返回 0）
- [ ] 负数余额（负债账户）

### 5. test_services_reconciliation.py - 对账执行服务测试

**测试用例**：

#### 5.1 无差额场景

- [ ] 预期余额 = 实际余额，仅生成 `balance` 指令
- [ ] 验证指令格式正确（日期、账户、币种、金额）
- [ ] 验证指令写入 .bean 文件

#### 5.2 有差额场景 - 仅 transaction

- [ ] 有差额，用户添加 transaction 记录完全分配差额
- [ ] 生成 transaction + balance 指令（按顺序）
- [ ] 验证 transaction 指令格式（借方、贷方账户、金额）

#### 5.3 有差额场景 - 仅 pad

- [ ] 有差额，用户未添加 transaction，由 pad 账户兜底
- [ ] 生成 pad + balance 指令（按顺序）
- [ ] 验证 pad 指令格式（账户、pad 账户）

#### 5.4 有差额场景 - transaction + pad

- [ ] 有差额，用户添加 transaction 部分分配，剩余由 pad 兜底
- [ ] 生成 transaction + pad + balance 指令（按顺序）
- [ ] 验证差额分配正确（transaction 金额 + pad 金额 = 差额）

#### 5.5 多币种对账

- [ ] 对账 CNY 币种（生成 CNY 指令）
- [ ] 对账 COIN 币种（生成 COIN 指令）
- [ ] 对账不同币种不影响其他币种余额

#### 5.6 对账完成后创建下一个待办

- [ ] 基于当前待办的 `scheduled_date` 计算下一个日期（非 `completed_date`）
- [ ] 验证周期性保持（如每月 1 号对账，即使 5 号完成，下次仍为下月 1 号）
- [ ] 更新当前待办状态为 `completed` 并记录 `completed_date`

#### 5.7 错误处理

- [ ] 待办不存在时抛出异常
- [ ] 待办状态不是 pending 时抛出异常
- [ ] 账本文件写入失败时抛出异常

### 6. test_serializers.py - 序列化器测试

**测试用例**：

#### 6.1 ScheduledTaskSerializer

- [ ] 序列化待办对象（包含所有字段）
- [ ] 反序列化创建待办（验证必填字段）
- [ ] 验证 scheduled_date 格式
- [ ] 验证 status 字段选择

#### 6.2 ReconciliationStartSerializer

- [ ] 序列化对账开始响应（预期余额、币种列表）

#### 6.3 ReconciliationExecuteSerializer

- [ ] 验证实际余额字段（必填、数值类型）
- [ ] 验证币种字段（必填、选择）
- [ ] 验证 transaction 记录列表（可选）
- [ ] 验证 transaction 记录格式（账户、金额）

### 7. test_validators.py - 验证器测试

**测试用例**：

#### 7.1 对账执行验证器

- [ ] 验证实际余额不能为空
- [ ] 验证币种不能为空
- [ ] 验证 transaction 记录金额总和与差额匹配
- [ ] 验证 transaction 记录账户格式（Beancount 账户路径）

### 8. test_views_tasks.py - 待办管理 API 测试

**测试用例**：

#### 8.1 待办列表查询

- [ ] GET `/api/reconciliation/tasks/` 返回当日到期且状态为 pending 的待办
- [ ] 查询条件：`scheduled_date <= today()` 且 `status = pending`
- [ ] 分页功能正常
- [ ] 仅返回当前用户的待办

#### 8.2 待办详情查询

- [ ] GET `/api/reconciliation/tasks/{id}/` 返回待办详情
- [ ] 非当前用户的待办返回 404

#### 8.3 修改待办执行日期

- [ ] PATCH `/api/reconciliation/tasks/{id}/` 更新 scheduled_date
- [ ] 验证新日期格式正确
- [ ] 验证不影响账户的周期配置
- [ ] 验证不能修改已完成或已取消的待办

#### 8.4 取消待办

- [ ] DELETE `/api/reconciliation/tasks/{id}/` 将状态更新为 cancelled
- [ ] 验证不能取消已完成的待办

#### 8.5 权限测试

- [ ] 未认证用户返回 401
- [ ] 其他用户的待办返回 404

### 9. test_views_reconciliation.py - 对账执行 API 测试

**测试用例**：

#### 9.1 开始对账（计算预期余额）

- [ ] POST `/api/reconciliation/start/` 返回预期余额（多币种）
- [ ] 验证返回格式（币种列表、各币种余额）
- [ ] 待办不存在时返回 404
- [ ] 待办状态不是 pending 时返回 400

#### 9.2 执行对账 - 无差额

- [ ] POST `/api/reconciliation/execute/` 无差额场景
- [ ] 验证生成 balance 指令
- [ ] 验证指令写入 .bean 文件
- [ ] 验证待办状态更新为 completed
- [ ] 验证创建下一个待办（基于 scheduled_date）

#### 9.3 执行对账 - 有差额（仅 transaction）

- [ ] POST `/api/reconciliation/execute/` 有差额，仅 transaction
- [ ] 验证生成 transaction + balance 指令
- [ ] 验证指令顺序正确

#### 9.4 执行对账 - 有差额（仅 pad）

- [ ] POST `/api/reconciliation/execute/` 有差额，仅 pad
- [ ] 验证生成 pad + balance 指令
- [ ] 验证使用用户配置的默认调整账户

#### 9.5 执行对账 - 有差额（transaction + pad）

- [ ] POST `/api/reconciliation/execute/` 有差额，transaction + pad
- [ ] 验证生成 transaction + pad + balance 指令
- [ ] 验证指令顺序正确

#### 9.6 多币种对账

- [ ] 对账 CNY 币种生成 CNY 指令
- [ ] 对账 COIN 币种生成 COIN 指令

#### 9.7 错误处理

- [ ] 实际余额格式错误返回 400
- [ ] transaction 记录金额总和与差额不匹配返回 400
- [ ] 账本文件写入失败返回 500

### 10. test_integration.py - 集成测试（可选）

**测试用例**：

#### 10.1 完整对账流程

- [ ] 设置账户对账周期 → 创建待办 → 查看待办列表 → 执行对账 → 验证下一个待办创建

#### 10.2 周期配置变更流程

- [ ] 修改周期配置 → 验证相关待办不自动更新
- [ ] 删除周期配置 → 验证相关待办状态变更为 cancelled

## 测试覆盖率目标

- **模型测试**：100% 覆盖率
- **服务测试**：核心业务逻辑 100% 覆盖率
- **API 测试**：所有端点 100% 覆盖率
- **边界情况**：关键边界情况 100% 覆盖

## 测试数据准备

### Mock 数据

- Beancount 账本文件内容（多币种场景）
- BeanFileManager 文件操作
- beancount.loader 加载结果

### 测试账户示例

```python
Assets:Savings:Bank:ICBC:C5244           # 工商银行
Assets:Savings:Web:AliPay             # 支付宝
Assets:Savings:Web:WechatPay             # 微信
Income:Investment:Interest # 投资收益（pad 账户）
```



## 注意事项

1. **conftest.py 层级继承**：

- 根目录的 `conftest.py` 提供全局清理功能，**保持不变**
- `reconciliation/tests/conftest.py` 只定义该模块特定的 fixtures
- pytest 会自动合并所有层级的 fixtures，无需手动导入

2. **测试隔离**：每个测试用例独立，不依赖其他测试的执行顺序
3. **数据清理**：

- 根目录的 `cleanup_test_assets_per_function` fixture 会自动清理测试创建的 Assets 目录
- 数据库数据通过 `@pytest.mark.django_db` 自动回滚
- 无需在模块 conftest.py 中重复实现清理逻辑

4. **Mock 外部依赖**：Mock `BeanFileManager`、`beancount.loader` 等外部依赖
5. **日期处理**：使用 `freezegun` 或 `unittest.mock.patch` 固定测试日期
6. **多币种测试**：确保覆盖 CNY、COIN 等不同币种场景